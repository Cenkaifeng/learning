<!-- TOC -->

- [æ¦‚å¿µ](#æ¦‚å¿µ)
- [ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰](#ä»»åŠ¡é˜Ÿåˆ—task-queue)
- [å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡](#å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡)
  - [å®ä»»åŠ¡ï¼ˆmacrotaskï¼‰](#å®ä»»åŠ¡macrotask)
  - [å¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰](#å¾®ä»»åŠ¡microtask)
- [æµè§ˆå™¨å’Œ Node](#æµè§ˆå™¨å’Œ-node)
  - [æµè§ˆå™¨çš„ Event Loop](#æµè§ˆå™¨çš„-event-loop)
    - [Microtask æ£€æŸ¥ç‚¹](#microtask-æ£€æŸ¥ç‚¹)
  - [Node çš„ Event Loop](#node-çš„-event-loop)
    - [Node å’Œ æµè§ˆå™¨å…³äº Event Loop çš„ä¸»è¦åŒºåˆ«](#node-å’Œ-æµè§ˆå™¨å…³äº-event-loop-çš„ä¸»è¦åŒºåˆ«)
    - [Event Loop çš„é˜¶æ®µæ¦‚è§ˆ](#event-loop-çš„é˜¶æ®µæ¦‚è§ˆ)
      - [timers](#timers)
      - [poll](#poll)
      - [check](#check)
    - [setImmediate() vs setTimeout()](#setimmediate-vs-settimeout)
    - [process.nextTick()](#processnexttick)
      - [process.nextTick() vs setImmediate()](#processnexttick-vs-setimmediate)
      - [ä¸ºä»€ä¹ˆä½¿ç”¨ process.nextTick()](#ä¸ºä»€ä¹ˆä½¿ç”¨-processnexttick)
- [å‚è€ƒ](#å‚è€ƒ)

<!-- /TOC -->
# æ¦‚å¿µ
äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ˜¯ç”¨æ¥åè°ƒå„ç§äº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬æ‰§è¡Œã€UI æ¸²æŸ“ã€ç½‘ç»œè¯·æ±‚ç­‰çš„ä¸€ç§æœºåˆ¶

Event Loop å¹¶ä¸æ˜¯ ECMAScript æ ‡å‡†ä¸­å®šä¹‰çš„ï¼Œè€Œæ˜¯ HTML æ ‡å‡†å®šä¹‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Event Loop æ˜¯å±äº JavaScript Runtimeï¼Œæ˜¯ç”±å®¿ä¸»ç¯å¢ƒï¼ˆæ¯”å¦‚æµè§ˆå™¨ã€Nodeï¼‰æä¾›çš„

# ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰
ä¸€ä¸ª Event Loop ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ª Task Queueï¼Œæ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æœ‰åºåˆ—è¡¨ï¼Œå­˜æ”¾ç€ä¸åŒ Task Sourceï¼ˆä»»åŠ¡æºï¼‰çš„ Task
> å…³äº Taskï¼Œå¸¸æœ‰äººç§°å®ƒä¸º Marcotaskï¼Œä½†å…¶å® HTML æ ‡å‡†ä¸­å¹¶æ²¡æœ‰è¿™ç§è¯´æ³•

HTML æ ‡å‡†ä¸­å®šä¹‰äº†å‡ ç§å¸¸è§çš„ä»»åŠ¡æºï¼š
- DOM æ“ä½œ
- ç”¨æˆ·äº¤äº’
- ç½‘ç»œè¯·æ±‚
- History API æ“ä½œ

# å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
äº‹ä»¶å¾ªç¯çš„å¼‚æ­¥é˜Ÿåˆ—æœ‰ä¸¤ç§ï¼šå®ä»»åŠ¡ï¼ˆmacroï¼‰é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡ï¼ˆmicroï¼‰é˜Ÿåˆ—ã€‚**å®ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥æœ‰å¤šä¸ªï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—åªæœ‰ä¸€ä¸ª**

## å®ä»»åŠ¡ï¼ˆmacrotaskï¼‰
- `setTimeout`
- `setInterval`
- `setImmediate`
  
## å¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰
- `Promise.then catch finally`
- `MutationObserver`
- `Object.observe`
- `process.nextTick`ï¼ˆNodeï¼‰


# æµè§ˆå™¨å’Œ Node
## æµè§ˆå™¨çš„ Event Loop
åœ¨è§„èŒƒ Processing model å®šä¹‰äº† Event Loop çš„å¾ªç¯è¿‡ç¨‹ï¼š
1. é€‰æ‹©å½“å‰è¦æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé€‰æ‹©ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ€å…ˆï¼ˆè€ï¼‰è¿›å…¥çš„ä»»åŠ¡ã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç›´æ¥è·³åˆ°å¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰çš„æ‰§è¡Œæ­¥éª¤
2. å°†æœ€å…ˆè¿›å…¥çš„ä»»åŠ¡è®¾ç½®ä¸ºä»»åŠ¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤
3. å°†äº‹ä»¶å¾ªç¯çš„ä»»åŠ¡è®¾ç½®ä¸ºå·²é€‰æ‹©çš„ï¼ˆæœ€å…ˆè¿›å…¥çš„ï¼‰ä»»åŠ¡
4. æ‰§è¡Œä»»åŠ¡
5. å°†äº‹ä»¶å¾ªç¯ä¸­å½“å‰è¿è¡Œä»»åŠ¡è®¾ç½®ä¸º null
6. Microtaskï¼šæ‰§è¡Œå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼‰
7. æ›´æ–°æ¸²æŸ“
8. è¿”å›ç¬¬ä¸€æ­¥

ç®€åŒ–æ­¥éª¤ï¼š
1. æ‰§è¡Œ task
2. æ‰§è¡Œ microtasks
3. æ›´æ–°æ¸²æŸ“ï¼ˆUpdate the renderingï¼‰

### Microtask æ£€æŸ¥ç‚¹
é‡ç‚¹èŠä¸€èŠæ­¥éª¤ 6ï¼Œå…¶å®æ­¥éª¤ 6 ç±»ä¼¼æ­¥éª¤ 2-5ï¼š
1. è®¾ç½® microtask æ£€æŸ¥ç‚¹æ ‡å¿—ä¸º true
2. å½“æ—¶é—´å¾ªç¯ microtask æ‰§è¡Œä¸ä¸ºç©ºæ—¶ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€å…ˆè¿›å…¥çš„ microtask é˜Ÿåˆ—çš„ microtask
3. å°†é€‰æ‹©çš„ microtask ä» microtask é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå¹¶æ‰§è¡Œè¯¥ microtaskï¼ˆï¼‰
4. å°†å·²æ‰§è¡Œå®Œæˆçš„ microtask ç½®ä¸º null
5. æ¸…ç† IndexexDB äº‹åŠ¡
6. è®¾ç½® microtask æ£€æŸ¥ç‚¹æ ‡å¿—ä¸º false

ç¨å¾®é€šä¿—ä¸€ç‚¹çš„ç†è§£æ˜¯ï¼š  
æ‰§è¡Œæ ˆåœ¨æ‰§è¡Œå®Œ**åŒæ­¥ä»»åŠ¡**åï¼ŒæŸ¥çœ‹**æ‰§è¡Œæ ˆ**æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ‰§è¡Œæ ˆä¸ºç©ºï¼Œå°±å»æ£€æŸ¥**å¾®ä»»åŠ¡**ï¼ˆmicrotaskï¼‰é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°±æ‰§è¡Œ **task**ï¼ˆå®ä»»åŠ¡ï¼‰ï¼Œå¦åˆ™å°±ä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ‰€æœ‰å¾®ä»»åŠ¡  
æ¯æ¬¡å•ä¸ª**å®ä»»åŠ¡**æ‰§è¡Œå®Œæ¯•åï¼Œæ£€æŸ¥**å¾®ä»»åŠ¡**ï¼ˆmicrotaskï¼‰é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼ŒæŒ‰ç…§**å…ˆå…¥å…ˆå‡º**çš„è§„åˆ™å…¨éƒ¨æ‰§è¡Œ**å¾®ä»»åŠ¡**ï¼ˆmicrotaskï¼‰åï¼Œè®¾ç½®**å¾®ä»»åŠ¡**ï¼ˆmicrotaskï¼‰é˜Ÿåˆ—ä¸º nullï¼Œç„¶åå†æ‰§è¡Œ**å®ä»»åŠ¡**ï¼Œå¦‚æ­¤å¾ªç¯

## Node çš„ Event Loop
![Node Event Loop](http://ww1.sinaimg.cn/large/68307314ly1gonut5mnx1j20f3067mx7.jpg)

Node ä¸­çš„ Event Loop æ˜¯åŸºäº [libuv](http://docs.libuv.org/en/v1.x/design.html) å®ç°çš„ï¼Œè€Œ libuv æ˜¯ Node çš„æ–°è·¨å¹³å°æŠ½è±¡å±‚ï¼Œlibuv ä½¿ç”¨å¼‚æ­¥ï¼Œäº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹æ–¹å¼ï¼Œæ ¸å¿ƒæ˜¯æä¾› i/o çš„æ—¶é—´å¾ªç¯å’Œå¼‚æ­¥å›è°ƒã€‚libuv çš„ API åŒ…å«æ—¶é—´ã€éé˜»å¡çš„ç½‘ç»œï¼Œå¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œå­è¿›ç¨‹ç­‰

Event Loop å°±æ˜¯åœ¨ libuv å®ç°çš„

### Node å’Œ æµè§ˆå™¨å…³äº Event Loop çš„ä¸»è¦åŒºåˆ«
æµè§ˆå™¨ä¸­çš„å¾®ä»»åŠ¡å®åœ¨**æ¯ä¸ªç›¸åº”çš„ï¼ˆå®ï¼‰ä»»åŠ¡**ä¸­æ‰§è¡Œçš„ï¼Œè€Œ Node ä¸­çš„å¾®ä»»åŠ¡æ˜¯åœ¨**ä¸åŒé˜¶æ®µä¹‹é—´**æ‰§è¡Œçš„

### Event Loop çš„é˜¶æ®µæ¦‚è§ˆ

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
Node çš„ Event Loop åˆ†ä¸º 6 ä¸ªé˜¶æ®µï¼š
- timersï¼šæ‰§è¡Œ`setTimeout()`å’Œ`setInterval()`ä¸­åˆ°æœŸçš„å›è°ƒ
- pending callbackï¼šæ‰§è¡Œä¸Šä¸€è½®å¾ªç¯ä¸­æœ‰å°‘æ•°çš„ I/O å›è°ƒ
- idle, prepareï¼šä»… Node å†…éƒ¨ä½¿ç”¨
- pollï¼šç­‰å¾…æ–°çš„ I/O æ—¶é—´ï¼ŒNode åœ¨é€‚å½“æ¡ä»¶ä¸‹ä¼šé˜»å¡åœ¨è¿™é‡Œ
- checkï¼šæ‰§è¡Œ`setImmediate()`çš„å›è°ƒ
- close callbacksï¼šæ‰§è¡Œ close äº‹ä»¶çš„å›è°ƒ

ä»¥ä¸‹ç€é‡è®² timersã€pollã€check è¿™ 3 ä¸ªé˜¶æ®µ

#### timers
timers é˜¶æ®µä¼šæ‰§è¡Œ`setTimeout()`å’Œ`setInterval()`å›è°ƒï¼Œå¹¶ä¸”ç”± poll é˜¶æ®µæ§åˆ¶çš„  
åŒæ ·çš„ï¼Œ**Node å®šæ—¶å™¨æŒ‡å®šçš„ä¹Ÿä¸æ˜¯ç¡®åˆ‡çš„æ‰§è¡Œæ—¶é—´ï¼Œè€Œæ˜¯æœ€çŸ­çš„é—´éš”æ—¶é—´**

#### poll
pollï¼ˆè½®è¯¢ï¼‰é˜¶æ®µä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š
- æ‰§è¡Œ I/O å›è°ƒ
- å¤„ç† poll é˜Ÿåˆ—ä¸­çš„äº‹ä»¶

å½“ Event Loop è¿›å…¥ poll é˜¶æ®µæ—¶ï¼š
1. ä¸”åœ¨ timers é˜¶æ®µæ²¡æœ‰å¯æ‰§è¡Œçš„å®šæ—¶å™¨æ—¶ï¼Œå°†å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
- å¦‚æœ poll é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä¼šéå†å›è°ƒé˜Ÿåˆ—å¹¶åŒæ­¥æ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ºç©ºæˆ–è¾¾åˆ°ç³»ç»Ÿé™åˆ¶
- å¦‚æœ poll é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šå‘ç”Ÿä¸¤ä»¶äº‹ï¼š
  - å¦‚æœæœ‰`setImmediate()`å›è°ƒéœ€è¦æ‰§è¡Œï¼Œpoll é˜¶æ®µä¼šåœæ­¢å¹¶è¿›å…¥åˆ° check é˜¶æ®µæ‰§è¡Œå›è°ƒ
  - å¦‚æœæ²¡æœ‰`setImmediate()`å›è°ƒï¼Œä¼šç­‰å¾…å›è°ƒè¢«åŠ å…¥åˆ°é˜Ÿåˆ—å¹¶ç«‹å³æ‰§è¡Œå›è°ƒ
2. poll é˜Ÿåˆ—ä¸ºç©ºï¼ŒEvent Loop ä¼šæ£€æŸ¥è®¡æ—¶å™¨çš„è®¾å®šæ—¶é—´å¦å·²ç»è¶…æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ï¼ŒEvent Loop å›åˆ° timers é˜¶æ®µï¼Œå¹¶æ‰§è¡Œè®¡æ—¶å™¨çš„å›è°ƒ

ç”¨ç¨‹åºæ¥è§£é‡Šçš„è¯ï¼Œæ˜¯è¿™æ ·ï¼š
```ts
type Callback = callback(...args): any;
interface Timer = {
    callback: Callback
    delay: number
};

const polls: Callback[] = [];
const timers: Timer[] = [];
const immediates: Callback[] = [];
const newCallbacks: Callback = function() {};
let time = 0;

const EventLoop = {
    status: '',
    timers() {
        this.status = 'timers';

        timers.forEach(timer => time > timer.delay timer.callback())
    },
    poll() {
        this.status = 'poll';

        if (!timers.length) {
           if (polls.length) {
               polls.forEach(poll => poll())
           } else {
               if (immediates.length) {
                  immediates.forEach(immediate => immediate()) 
               } else {
                   poll.push(newCallbacks);
                   newCallbacks();
                   poll.shift();
               }
           }
        } else {
            this.timers();
        }
    }
};

// è¿›å…¥ poll é˜¶æ®µ
EventLoop.poll();
```

#### check
check é˜¶æ®µå‘ç”Ÿåœ¨ poll é˜¶æ®µä¹‹åã€‚å¦‚æœ poll é˜¶æ®µå¤„äºç©ºé—²çŠ¶æ€ï¼Œå¹¶ä¸”`setImmediate`é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™è¿›å…¥æ­¤ï¼ˆcheckï¼‰é˜¶æ®µï¼Œè€Œä¸æ˜¯ç»§ç»­ç­‰å¾…

`setImmediate()`å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è®¡æ—¶å™¨ï¼Œå®ƒåœ¨äº‹ä»¶å¾ªç¯çš„å•ç‹¬é˜¶æ®µä¸­è¿è¡Œã€‚å®ƒä½¿ç”¨ libuv API è°ƒåº¦å›è°ƒï¼Œä¸€éåœ¨ poll é˜¶æ®µå®Œæˆåæ‰§è¡Œ

æ‰€ä»¥ï¼Œé€šå¸¸åœ¨ä»£ç æ‰§è¡Œæ—¶ï¼ŒEvent Loop æœ€ç»ˆå°†è¿›å…¥ poll é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œå®ƒå°†ç­‰å¾…è¯·æ±‚ã€è¿æ¥ç­‰ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»£ç é‡Œé¢è®¾ç½®äº†`setImmediate()`è¿›è¡Œå›è°ƒï¼Œå¹¶ä¸” poll é˜¶æ®µå˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œé‚£ä¹ˆ poll é˜¶æ®µç›´æ¥ç»“æŸå¹¶è¿›å…¥ check é˜¶æ®µï¼Œä¸æ˜¯ç­‰å¾… poll äº‹ä»¶

### setImmediate() vs setTimeout()
ä¸¤è€…ç›¸ä¼¼ï¼Œä½†è°ƒç”¨æ—¶æœºå’Œé˜¶æ®µä¸åŒ

- `setImmediate()`åœ¨ poll é˜¶æ®µå®Œæˆæ—¶æ‰§è¡Œï¼Œå³ check é˜¶æ®µ æ‰§è¡Œ
- `setTimeout()`åœ¨ poll é˜¶æ®µä¸ºç©ºé—²æ—¶ï¼Œä¸”è®¾ç½®æ—¶é—´åˆ°è¾¾åæ‰§è¡Œï¼Œä½†å®ƒæ˜¯åœ¨ timers é˜¶æ®µæ‰§è¡Œ

ä¸¤ä¸ªè®¡æ—¶å™¨çš„æ‰§è¡Œé¡ºåºæ˜¯æ ¹æ®å®ƒä»¬è¢«è°ƒç”¨çš„ä¸Šä¸‹æ–‡è€Œå˜åŒ–ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œé¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼Œä¼šå—åˆ°è¿›ç¨‹æ€§èƒ½çš„é™åˆ¶ï¼š
```js
// timeout_vs_immediate.js
setTimeout(() => {
    console.log('timeout');
}, 0);

setImmediate(() => {
    console.log('immediate');
});

// terminal
$ node timeout_vs_immediate.js
timeout
immediate

$ node timeout_vs_immediate.js
immediate
timeout
```
è€Œåœ¨åŒä¸€ä¸ª I/O å‘¨æœŸå†…è°ƒç”¨ä¸¤è€…ï¼Œæ€»æ˜¯å…ˆæ‰§è¡Œ`setImmediate()`ï¼Œç„¶åå†æ‰§è¡Œ`setTimeout()`
```js
// timeout_vs_immediate.js
const fs = require('fs');

fs.readFile(__filename, () => {
  setTimeout(() => {
    console.log('timeout');
  }, 0);
  setImmediate(() => {
    console.log('immediate');
  });
});

// terminal
$ node timeout_vs_immediate.js
immediate
timeout

$ node timeout_vs_immediate.js
immediate
timeout
```

### process.nextTick()
`process.nextTick()`ä¹Ÿæ˜¯å¼‚æ­¥ API ä¹‹ä¸€ã€‚ä½†æ˜¯`process.nextTick()`åœ¨æŠ€æœ¯ä¸Šä¸æ˜¯ Event Loop çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼ŒEvent Loop é˜¶æ®µçš„æ“ä½œç»“æŸåï¼ŒnextTick é˜Ÿåˆ—å°±ä¼šè¢«å¤„ç†
```js
setTimeout(() => {
 console.log('timer1')
 Promise.resolve().then(function() {
   console.log('promise1')
 })
}, 0)
process.nextTick(() => {
 console.log('nextTick')
 process.nextTick(() => {
   console.log('nextTick')
   process.nextTick(() => {
     console.log('nextTick')
     process.nextTick(() => {
       console.log('nextTick')
     })
   })
 })
})
// nextTick => nextTick => nextTick => nextTick => timer1 => promise1
```

æ¢å¥è¯è¯´ï¼Œ**å½“æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¦‚æœå­˜åœ¨ nextTick é˜Ÿåˆ—ï¼Œå°±ä¼šæ¸…ç©ºé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”ä¼˜å…ˆäºå…¶ä»– microtask æ‰§è¡Œ**

#### process.nextTick() vs setImmediate()
- `process.nextTick()`åœ¨åŒä¸€é˜¶æ®µç«‹å³æ‰§è¡Œ
- `setImmediate()`åœ¨ä¸‹ä¸€ä¸ªæ—¶é—´å¾ªç¯ä¸­çš„ check é˜¶æ®µè§¦å‘

å®é™…ä¸Šï¼Œä¸¤è€…åå­—åº”è¯¥äº’æ¢ã€‚å› ä¸º`process.nextTick()`è§¦å‘æ—¶æœºæ€»æ˜¯æ—©äº`setImmediate()`ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå†å²åŒ…è¢±ã€‚

æ‰€ä»¥ï¼ŒNode å®˜æ–¹æ¨èæˆ‘ä»¬å°½é‡ä½¿ç”¨`setImmediate()`ï¼Œå› ä¸ºè¿™æ ·æ›´å®¹æ˜“ç†è§£  
> We recommend developers use setImmediate() in all cases because it's easier to reason about.

#### ä¸ºä»€ä¹ˆä½¿ç”¨ process.nextTick() 
ä¸¤ä¸ªä¸»è¦åŸå› ï¼š
1. å…è®¸ç”¨æˆ·å¤„ç†é”™è¯¯ï¼Œæ¸…æ¥šå½“æ—¶ä¸éœ€è¦çš„ä»»ä½•èµ„æºï¼Œæˆ–è€…å† Event Loop ç»§ç»­ä¹‹å‰å†æ¬¡å°è¯•è¯·æ±‚
2. åœ¨äº‹æƒ…å¾ªç¯ä¹‹å‰ï¼Œæœ‰å¿…è¦å…è®¸å›è°ƒåœ¨è°ƒç”¨å †æ ˆè§£é™¤ä¹‹åæ‰§è¡Œ

# å‚è€ƒ
- [The Node.js Event Loop, Timers, and process.nextTick](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
- [è¯¦è§£JavaScriptä¸­çš„Event Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æœºåˆ¶](https://zhuanlan.zhihu.com/p/33058983)
- [æ·±å…¥ç†è§£ JavaScript Event Loop](https://zhuanlan.zhihu.com/p/34229323)
- [(2.4wå­—,å»ºè®®æ”¶è—)ğŸ˜‡åŸç”ŸJSçµé­‚ä¹‹é—®(ä¸‹), å†²åˆºğŸš€è¿›é˜¶æœ€åä¸€å…¬é‡Œ(é™„ä¸ªäººæˆé•¿ç»éªŒåˆ†äº«)](https://juejin.cn/post/6844904004007247880#heading-10)
- [ä¸€æ¬¡å¼„æ‡‚Event Loopï¼ˆå½»åº•è§£å†³æ­¤ç±»é¢è¯•é—®é¢˜ï¼‰](https://juejin.cn/post/6844903764202094606)
- [æµè§ˆå™¨å’ŒNodeJSä¸­ä¸åŒçš„Event Loop](https://github.com/kaola-fed/blog/issues/234#)
- [ã€THE LAST TIMEã€‘å½»åº•åƒé€ JavaScript æ‰§è¡Œæœºåˆ¶](https://juejin.cn/post/6844903955286196237#heading-3)
- [æµè§ˆå™¨ä¸Nodeçš„äº‹ä»¶å¾ªç¯(Event Loop)æœ‰ä½•åŒºåˆ«?](https://zhuanlan.zhihu.com/p/54882306)